<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>내 블로그</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="/postcss.css">
  </head>
  <body>
    <%- include('menu.html') %>
    <%- include('posttable.ejs', {data : total}) %>
    <p></p>
    <p></p>
    <div class="layout_content">
      <p></p>
      <div class="post content">
        <% if (data) {%>
          <strong class="title text"><%= data.title %></strong>
          <p></p>
          <% let postdata = new Date(data.date) %>
          <%= data.Username %><div class="postdate"><%= postdata.toLocaleDateString() %></div>
          <% if (LoginUser.neighborId.indexOf(user.userid) != -1) { %>
            <button type="button" class="btn btn-outline-primary" disabled = 'disabled' >이웃 추가됨</button>
            <p></p>
          <% }else if (LoginUser.userid == user.userid){ %>
            <p></p>
          <% }else{ %>
            <button class="neigh btn btn-outline-primary">이웃 추가</button>
            <p></p>
          <% } %>
          <p class="text"><%- data.content.replace(/\n/g, '<br>') %></p>
          <% if (data.type == null) { %>
          <% }else if(data.type.startsWith('image')) { %>
            <img src="<%= data.path %>">
          <%}else if (data.type == 'text/plain') { %>
            <iframe src="<%= data.path %>" width="700" frameborder="0"></iframe>
          <% } %>
          <p></p>
        <% if (Auth){ %>
          <button class="edit btn btn-outline-primary" data-id="<%= data._id %>">수정</button>
          <button class="delete btn btn-outline-primary" data-id="<%=data._id %>">삭제</button>
        <% } %>
        <% }else{ %>
            <p>
                  게시글이 없습니다.
              작성하기 버튼을 눌러서 첫 글을 작성해주세요.
            </p>
        <% } %> 
      </div>
      <div class="aside">
        <button class="menu btn btn-outline-primary" onclick="location.href = '/save'">작성하기</button>
        <% if(Auth){ %><p></p>
        <% }else{ %>
          <button type="button" onclick="location.href = '/list/<%=LoginUser.userid%>'" class = "menu btn btn-outline-primary">내 블로그 가기</button>
        <% } %>
        
        <ul class="list-group list-group-horizontal">
          <li class="list-group-item">이웃목록</li>
        </ul>
        <% if(user.neighbor != undefined){ %>
        <% for(let i = 0; i < user.neighbor.length; i+=2){ %>
          <ul class="list-group list-group-horizontal">
            <li class="list-group-item"><a href="/list/<%=user.neighborId[i] %>"><%= user.neighbor[i] %></a></li>
            <li class="list-group-item"><a href="/list/<%=user.neighborId[i+1] %>"><%= user.neighbor[i + 1] %></a></li>
          </ul>
        <% } %>
        <% } %>
      </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script>
      $('.delete').click(function(e){
          let sid = e.target.dataset.id;
          $.ajax({
            type : 'post',
            url : '/delete',
            data : {_id : sid}
          }).done(function(e){
            location.href = "/list/<%=user.userid  %>";
          })
        })
      $('.edit').click((e) => {
        console.log('클릭');
        let sid = e.target.dataset.id;
        location.href = '/edit/'+ sid;
      });
      $('.neigh').click((e) => {
        let postid = '<%=user.userid %>';
        let post_username = '<%=user.Username %>'; 
        let loginid = '<%=LoginUser.userid%>';
        $.ajax({
          type: 'post',
          url : '/saveNeighbor',
          data : {postid : postid, postname : post_username, loginid : loginid}
        }).done((e) => {
          location.reload(true);
        })
      })
    </script>
  </body>
</html>